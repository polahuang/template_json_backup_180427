(function(){var t=function(t){if(!t||!t.canvas||!t.path)throw"ImgZoom constructor: missing arguments canvas or path";this.canvas=t.canvas,this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.context=this.canvas.getContext("2d"),this.desktop=t.desktop||!1,this.position={x:0,y:0},this.scale={x:.5,y:.5},this.imgTexture=new Image,this.imgTexture.src=t.path,this.lastZoomScale=null,this.lastX=null,this.lastY=null,this.mdown=!1,this.init=!1,this.checkRequestAnimationFrame(),requestAnimationFrame(this.animate.bind(this)),this.setEventListeners()};t.prototype={animate:function(){if(!this.init&&this.imgTexture.width){var t=null;t=this.canvas.clientWidth>this.canvas.clientHeight?this.canvas.clientWidth/this.imgTexture.width:this.canvas.clientHeight/this.imgTexture.height,this.scale.x=t,this.scale.y=t,this.init=!0}this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.imgTexture,this.position.x,this.position.y,this.scale.x*this.imgTexture.width,this.scale.y*this.imgTexture.height),requestAnimationFrame(this.animate.bind(this))},gesturePinchZoom:function(t){var i=!1;if(t.targetTouches.length>=2){var s=t.targetTouches[0],e=t.targetTouches[1],n=Math.sqrt(Math.pow(e.pageX-s.pageX,2)+Math.pow(e.pageY-s.pageY,2));this.lastZoomScale&&(i=n-this.lastZoomScale),this.lastZoomScale=n}return i},doZoom:function(t){if(t){var i=this.scale.x,s=this.scale.x+t/100,e=s-i,n=this.imgTexture.width*this.scale.x,a=this.imgTexture.height*this.scale.y,h=this.imgTexture.width*e,o=this.imgTexture.height*e,c=this.canvas.clientWidth/2,l=this.canvas.clientHeight/2,r=-(-this.position.x+c)/n,m=-(-this.position.y+l)/a,d=this.position.x+h*r,u=this.position.y+o*m,g=n+h,v=a+o;g<this.canvas.clientWidth||(d>0&&(d=0),d+g<this.canvas.clientWidth&&(d=this.canvas.clientWidth-g),v<this.canvas.clientHeight||(u>0&&(u=0),u+v<this.canvas.clientHeight&&(u=this.canvas.clientHeight-v),this.scale.x=s,this.scale.y=s,this.position.x=d,this.position.y=u))}},doMove:function(t,i){if(this.lastX&&this.lastY){var s=t-this.lastX,e=i-this.lastY,n=this.imgTexture.width*this.scale.x,a=this.imgTexture.height*this.scale.y;this.position.x+=s,this.position.y+=e,this.position.x>0?this.position.x=0:this.position.x+n<this.canvas.clientWidth&&(this.position.x=this.canvas.clientWidth-n),this.position.y>0?this.position.y=0:this.position.y+a<this.canvas.clientHeight&&(this.position.y=this.canvas.clientHeight-a)}this.lastX=t,this.lastY=i},setEventListeners:function(){this.canvas.addEventListener("touchstart",function(t){this.lastX=null,this.lastY=null,this.lastZoomScale=null}.bind(this)),this.canvas.addEventListener("touchmove",function(t){if(t.preventDefault(),2==t.targetTouches.length)this.doZoom(this.gesturePinchZoom(t));else if(1==t.targetTouches.length){var i=t.targetTouches[0].pageX-this.canvas.getBoundingClientRect().left,s=t.targetTouches[0].pageY-this.canvas.getBoundingClientRect().top;this.doMove(i,s)}}.bind(this)),this.desktop&&(window.addEventListener("keyup",function(t){187==t.keyCode||61==t.keyCode?this.doZoom(5):54==t.keyCode&&this.doZoom(-5)}.bind(this)),window.addEventListener("mousedown",function(t){this.mdown=!0,this.lastX=null,this.lastY=null}.bind(this)),window.addEventListener("mouseup",function(t){this.mdown=!1}.bind(this)),window.addEventListener("mousemove",function(t){var i=t.pageX-this.canvas.getBoundingClientRect().left,s=t.pageY-this.canvas.getBoundingClientRect().top;t.target==this.canvas&&this.mdown&&this.doMove(i,s),(i<=0||i>=this.canvas.clientWidth||s<=0||s>=this.canvas.clientHeight)&&(this.mdown=!1)}.bind(this)))},checkRequestAnimationFrame:function(){for(var t=0,i=["ms","moz","webkit","o"],s=0;s<i.length&&!window.requestAnimationFrame;++s)window.requestAnimationFrame=window[i[s]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[i[s]+"CancelAnimationFrame"]||window[i[s]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(i,s){var e=(new Date).getTime(),n=Math.max(0,16-(e-t)),a=window.setTimeout(function(){i(e+n)},n);return t=e+n,a}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}},this.ImgTouchCanvas=t}).call(this);
